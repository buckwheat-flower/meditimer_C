#include "Standard_FX.h"
#include "alarm1.h"
#include "pill.h"


//알람을 비프음으로 출력할때 사용하는 음들
#define DO    523
#define RE    587
#define MI    659
#define PA    698    
#define SOL   784
#define RA    880
#define SI    988
#define _DO   1046

extern int total_alarm = 0; // 알람 개수
int total_pills;


void List_alarm()
{
	int i, alarm_key;
	buble_alarm();

	system("cls");

	gotoxy(29, 1); printf("<알람 목록>");
	gotoxy(2, 16); printf("┌───────────────────────────────────────────────────────────────┐");
	gotoxy(2, 17); printf("│");                                    gotoxy(66, 17); printf("│");
	gotoxy(2, 18); printf("│");                                    gotoxy(66, 18); printf("│");
	gotoxy(2, 19); printf("│");                                    gotoxy(66, 19); printf("│");
	gotoxy(2, 20); printf("│");                                    gotoxy(66, 20); printf("│");
	gotoxy(2, 21); printf("│");                                    gotoxy(66, 21); printf("│");
	gotoxy(2, 22); printf("└───────────────────────────────────────────────────────────────┘");


	gotoxy(20, 18); printf("[ 원하시는 버튼을 눌러주세요.]");
	gotoxy(13, 20); printf("1 : 알람 등록  2 : 알람 삭제  3 : 메인 메뉴");


	if (total_alarm == 0)
	{
		gotoxy(22, 5); printf("[ 등록된 알람이 없습니다.]");
		gotoxy(22, 7); printf(" >> 알람을 등록해주세요.<<");
	}

	else
	{
		gotoxy(3, 3);  printf("번호");
		gotoxy(9, 3);  printf("알약 이름");
		gotoxy(28, 3); printf("년");
		gotoxy(40, 3); printf("월");
		gotoxy(47, 3); printf("일");
		gotoxy(54, 3); printf("시");
		gotoxy(61, 3); printf("분");

		gotoxy(7, 3);  printf("│");
		gotoxy(26, 3); printf("│");
		gotoxy(38, 3); printf("│");
		gotoxy(45, 3); printf("│");
		gotoxy(52, 3); printf("│");
		gotoxy(59, 3); printf("│");

		gotoxy(3, 4); printf("────┼──────────────────┼───────────┼──────┼──────┼──────┼────\n");

		for (i = 0; i < total_alarm; i++)
		{
			gotoxy(7, 5 + i);  printf("│");
			gotoxy(26, 5 + i); printf("│");
			gotoxy(38, 5 + i); printf("│");
			gotoxy(45, 5 + i); printf("│");
			gotoxy(52, 5 + i); printf("│");
			gotoxy(59, 5 + i); printf("│");
			gotoxy(3, 5 + i); printf("[%d]", i + 1);
			gotoxy(9, 5 + i); printf("%s", pill[i].pill_name);
			gotoxy(28, 5 + i); printf("%d", arm[i].A_year);
			gotoxy(40, 5 + i); printf("%d", arm[i].A_month);
			gotoxy(47, 5 + i); printf("%d", arm[i].A_day);
			gotoxy(54, 5 + i); printf("%d", arm[i].A_hour);
			gotoxy(61, 5 + i); printf("%d", arm[i].A_min);
		}
	}

	while (_kbhit() == 0)
	{
		alarm_key = _getch();
		switch (alarm_key)
		{
		case '1':
			Make_alarm();
			MainUI();
		case '2':
			Remove_alarm();
			MainUI();
		case '3':
			MainUI();

		default:
			Sleep(1000);
			system("cls");
			printf("버튼을 다시 눌러주세요");
		}
		alarm_key = NULL;
	}
}


void Make_alarm() // 새 알람 만들기
{

	int i;
	int Makealarm;
	system("cls");

	if (total_pills == 0)
	{
		gotoxy(20, 6);   printf("┌───────────  알림 ──────────┐");
		gotoxy(20, 11);  printf("└────────────────────────────┘");
		gotoxy(20, 7);  printf("│");
		gotoxy(20, 8);  printf("│");
		gotoxy(20, 9);  printf("│");
		gotoxy(20, 10); printf("│");
		gotoxy(49, 7);  printf("│");
		gotoxy(49, 8);  printf("│");
		gotoxy(49, 9);  printf("│");
		gotoxy(49, 10); printf("│");


		gotoxy(25, 8); printf("등록된 알약이 없습니다. ");
		gotoxy(24, 9); printf("  알약을 등록해주세요. ");

		Sleep(2500);
		system("cls");
	}

	else
	{
		total_alarm++;

		gotoxy(5, 5); printf("번호 │");
		gotoxy(13, 5); printf("알약 이름\t\t   효능               일회 복용량");
		gotoxy(32, 5); printf("│");
		gotoxy(51, 5); printf("│");
		gotoxy(5, 6); printf("───");
		gotoxy(8, 6); printf("──┼─────────────────────┼──────────────────┼────────────");

		for (i = 0; i < total_pills; i++)
		{

			gotoxy(32, 7 + i); printf("│");
			gotoxy(51, 7 + i); printf("│");
			gotoxy(10, 7 + i); printf("│");
			gotoxy(5, 7 + i); printf("[%d]", i + 1);
			gotoxy(13, 7 + i); printf("%s", pill[i].pill_name);
			gotoxy(35, 7 + i); printf("%s", pill[i].pill_efficacy);
			gotoxy(54, 7 + i); printf("%d", pill[i].pill_quantity);

		}
		gotoxy(8, 3); printf("[ 알람을 등록하길 원하는 알약의 번호를 눌러주세요. ]");

		while (1)
		{
			if (_kbhit())
			{
				Makealarm = _getch();
				Makealarm = Makealarm - 49;
				if (Makealarm < total_pills && Makealarm >= 0)
				{
					break;
				}
			}

		}
		system("cls");

		gotoxy(15, 3); printf("[ 알람을 등록할 시간을 입력해주세요.]");
		gotoxy(14, 5); printf("알약 이름: %s, 효능 : %s, 일회 복용량 : %d", pill[Makealarm].pill_name, pill[Makealarm].pill_efficacy, pill[Makealarm].pill_quantity);

		gotoxy(12, 7); printf("─────────────────────────────────────────────");
		gotoxy(12, 17); printf("─────────────────────────────────────────────");
		
		strcpy_s(arm[total_alarm - 1].A_name, 20, pill[Makealarm].pill_name);
		arm[total_alarm - 1].A_quantity = pill[Makealarm].pill_quantity;
		
		gotoxy(24, 8);  printf("알람 년도 : ");
		scanf_s("%d", &arm[total_alarm - 1].A_year);

		gotoxy(24, 10); printf("알람 월   : ");
		scanf_s("%d", &arm[total_alarm - 1].A_month);

		gotoxy(24, 12); printf("알람 일   : ");
		scanf_s("%d", &arm[total_alarm - 1].A_day);

		gotoxy(24, 14); printf("알람 시간 : ");
		scanf_s("%d", &arm[total_alarm - 1].A_hour);

		gotoxy(24, 16); printf("알람 분   : ");
		scanf_s("%d", &arm[total_alarm - 1].A_min);

		Sleep(1500);
		system("cls");
		gotoxy(17, 8);   printf("┌─────────────  알림 ──────────────┐");
		gotoxy(16, 9);  printf(" │                                  │ ");
		gotoxy(17, 10);  printf("│    알람 등록이 완료되었습니다.   │");
		gotoxy(16, 11); printf(" │                                  │ ");
		gotoxy(16, 12); printf(" └──────────────────────────────────┘");
		Sleep(1500);
		system("cls");
	}
}


void Remove_alarm() // 원하는 알람 삭제
{
	system("cls");

	printf("<알람 삭제>\n");

	if (total_alarm <= 0)
	{
		gotoxy(17, 8);  printf(" ┌───────────── 알림 ──────────────┐");
		gotoxy(17, 9);  printf(" │                                 │");
		gotoxy(17, 10); printf(" │      삭제할 알람이 없습니다.    │");
		gotoxy(17, 11); printf(" │                                 │");
		gotoxy(17, 12); printf(" └─────────────────────────────────┘");


		Sleep(1700);
		system("cls");
	}

	else {

		int Removealarm = NULL;
		int i = 0;

		gotoxy(12, 3); printf("[ 삭제를 원하시는 알람의 번호를 눌러주세요. ]");

		gotoxy(3, 5);  printf("번호");
		gotoxy(9, 5);  printf("알약 이름");
		gotoxy(28, 5); printf("년");
		gotoxy(40, 5); printf("월");
		gotoxy(47, 5); printf("일");
		gotoxy(54, 5); printf("시");
		gotoxy(61, 5); printf("분");

		gotoxy(7, 5);  printf("│");
		gotoxy(26, 5); printf("│");
		gotoxy(38, 5); printf("│");
		gotoxy(45, 5); printf("│");
		gotoxy(52, 5); printf("│");
		gotoxy(59, 5); printf("│");

		gotoxy(3, 6); printf("────┼──────────────────┼───────────┼──────┼──────┼──────┼────\n");

		for (i = 0; i < total_alarm; i++)
		{
			gotoxy(7, 7 + i);  printf("│");
			gotoxy(26, 7 + i); printf("│");
			gotoxy(38, 7 + i); printf("│");
			gotoxy(45, 7 + i); printf("│");
			gotoxy(52, 7 + i); printf("│");
			gotoxy(59, 7 + i); printf("│");
			gotoxy(3, 7 + i); printf("[%d]", i + 1);
			gotoxy(9, 7 + i); printf("%s", arm[i].A_name);
			gotoxy(28, 7 + i); printf("%d", arm[i].A_year);
			gotoxy(40, 7 + i); printf("%d", arm[i].A_month);
			gotoxy(47, 7 + i); printf("%d", arm[i].A_day);
			gotoxy(54, 7 + i); printf("%d", arm[i].A_hour);
			gotoxy(61, 7 + i); printf("%d", arm[i].A_min);
		}

		while (1)
		{
			if (_kbhit())
			{
				Removealarm = _getch();
				Removealarm = Removealarm - 49;
				if (Removealarm < total_alarm && Removealarm >= 0)
				{
					for (int i = 0; i < total_alarm; i++)
					{
						if (Removealarm == i)
						{
							for (int j = Removealarm; j < total_alarm; j++)
							{
								arm[j] = arm[j + 1];
							}
						}
					}
					break;
				}

			}
		}
		total_alarm--;

		system("cls");
		gotoxy(17, 8);   printf("┌──────────── 알림 ─────────────┐");
		gotoxy(16, 9);  printf(" │                               │ ");
		gotoxy(17, 10);  printf("│   %d번 알람이 삭제되었습니다.  │", Removealarm + 1);
		gotoxy(16, 11); printf(" │                               │ ");
		gotoxy(16, 12); printf(" └───────────────────────────────┘");

		Sleep(1700);
		system("cls");
	}

}


void buble_alarm()
{
	int i, j;
	for (i = 0; i < total_alarm; i++)
	{
		for (j = 0; j < total_alarm - 1; j++)
		{
			if (arm[j].A_year > arm[j + 1].A_year)
			{
				temp = arm[j];
				arm[j] = arm[j + 1];
				arm[j + 1] = temp;
			}
			else if (arm[j].A_month > arm[j + 1].A_month)
			{
				temp = arm[j];
				arm[j] = arm[j + 1];
				arm[j + 1] = temp;
			}
			else if (arm[j].A_day > arm[j + 1].A_day)
			{
				temp = arm[j];
				arm[j] = arm[j + 1];
				arm[j + 1] = temp;
			}
			else if (arm[j].A_hour > arm[j + 1].A_hour)
			{
				temp = arm[j];
				arm[j] = arm[j + 1];
				arm[j + 1] = temp;
			}
			else if (arm[j].A_min > arm[j + 1].A_min)
			{
				temp = arm[j];
				arm[j] = arm[j + 1];
				arm[j + 1] = temp;
			}
		}
	}
}

int alarm_i = 0;
BOOL Check_alarm(int y, int m, int d, int h, int min) //현재 시각과 알람이 맞는지 확인
{
	for (int i = 0; i < total_alarm; i++)
	{
		if (y == arm[i].A_year)
			if (m == arm[i].A_month)
				if (d == arm[i].A_day)
					if (h == arm[i].A_hour)
						if (min == arm[i].A_min)
						{
							alarm_i = i;
							return 1;
						}
	}
	return 0;

	// 비교해서 맞으면 alarmcheck ++ 한 후, 화면전환
	// 다른 프로그램을 실행중일 때도 실행되어져야 함
}


void Active_alarm(int* alarm_Chk) // 알람 울림
{
	if (*alarm_Chk)	//인자로 받은 alarmChk값이 1이라면(현재 분에 처음출력되는 알람이라면)
					//(만약 체크를 하지 않는다면 알람이 설정된 '분'이 끝날때까지 1분동안 계속 알람이 울리게 됨
	{
		system("cls");
		// 알람 순서 결정하고 띄우기 !!

		gotoxy(17, 8);  printf(" %s(을)를 %d정 복용하세요 ", arm[alarm_i].A_name, arm[alarm_i].A_quantity);
		
		for (int i = 0; i < 4; i++)	//2번 출력
		{
			Beep(MI, 120);
			Beep(DO, 120);
			Beep(SOL, 120);
			Beep(DO, 120);
			Beep(SOL, 120);
			Beep(RA, 120);
			Beep(SOL, 120);
			Beep(DO, 120);
			Beep(RA, 120);
			Beep(SOL, 120);
			Beep(MI, 120);
			Beep(SOL, 120);		//전에 정의된 계이름을 이용해 비프음으로 음악연주

			Sleep(1000);		//1초 쉼표
		}
		system("cls");
	}

	*alarm_Chk = 0;	//알람이 실행되었으므로 중복알람 방지를 위해 alarmChk를 0으로 초기화

	// 만약 alarmcheck == 1 비프음
	// alaemcheck -- ,, 중복방지를 위해 초기화
}

// 알람을 등록하여 현재시간하고 비교 맞다면 울리고 